{% extends "base.html" %}

{% block title %}Promil Hesaplayƒ±cƒ± - Ne Yenir?{% endblock %}

{% block content %}
<div class="profile-wizard-container">
    <div class="container" style="padding-top: 100px; padding-bottom: 100px;">
        <!-- Header -->
        <div class="wizard-header text-center mb-4">
            <div class="wizard-icon mb-3">
                <i class="bi bi-speedometer"></i>
            </div>
            <h1 class="wizard-title">Promil Hesaplayƒ±cƒ±</h1>
            <p class="wizard-subtitle">Kan alkol seviyenizi (BAC) hesaplayƒ±n ve g√ºvenli kalƒ±n</p>

            <!-- Live Summary -->
            <div class="live-summary mt-4" id="liveSummary" style="display: none;">
                <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                    <span class="summary-badge">
                        <i class="bi bi-clock"></i>
                        <span id="summaryHours">0</span> saat
                    </span>
                    <span class="summary-divider">‚Ä¢</span>
                    <span class="summary-badge">
                        <i class="bi bi-cup"></i>
                        <span id="summaryDrinks">0</span> i√ßki
                    </span>
                    <span class="summary-divider">‚Ä¢</span>
                    <span class="summary-badge">
                        <i class="bi bi-droplet"></i>
                        <span id="summaryAlcohol">0</span> g alkol
                    </span>
                </div>
            </div>

            <!-- Warning Banner -->
            <div class="warning-banner mt-4">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span><strong>Ara√ß kullanmayƒ±n!</strong> Bu hesaplama yakla≈üƒ±k bir tahmindir.</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="wizard-progress mb-5">
            <div class="progress-container">
                <div class="progress-bar-fill" id="bacProgressBar"></div>
            </div>
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Profil</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">ƒ∞√ßkiler</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Sonu√ß</div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="wizard-card">
                    <form id="bacForm">
                        <!-- Step 1: Profil -->
                        <div class="wizard-step active" data-step="1">
                            <h3 class="step-title">Ki≈üisel Bilgiler</h3>
                            <p class="step-description">Size √∂zel hesaplama i√ßin birka√ß bilgi</p>

                            <div class="form-group-modern">
                                <label class="modern-label">Cinsiyet</label>
                                <div class="segmented-control">
                                    <input type="radio" name="gender" id="male" value="male" class="segment-input"
                                        checked>
                                    <label for="male" class="segment-label">
                                        <span class="segment-icon">üë®</span>
                                        <span class="segment-title">Erkek</span>
                                    </label>

                                    <input type="radio" name="gender" id="female" value="female" class="segment-input">
                                    <label for="female" class="segment-label">
                                        <span class="segment-icon">üë©</span>
                                        <span class="segment-title">Kadƒ±n</span>
                                    </label>

                                    <input type="radio" name="gender" id="other" value="male" class="segment-input">
                                    <label for="other" class="segment-label">
                                        <span class="segment-icon">üßë</span>
                                        <span class="segment-title">Diƒüer</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group-modern">
                                <label class="modern-label">
                                    <i class="bi bi-speedometer label-icon"></i>
                                    V√ºcut Aƒüƒ±rlƒ±ƒüƒ±
                                </label>
                                <div class="input-with-unit">
                                    <input type="range" class="weight-slider" id="weightSlider" min="30" max="150"
                                        value="70" oninput="updateWeight(this.value)">
                                    <div class="weight-display">
                                        <input type="number" class="modern-input text-center" id="weight" min="30"
                                            max="200" value="70" oninput="updateWeightSlider(this.value)" required>
                                        <span class="input-unit">kg</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group-modern">
                                <label class="modern-label">
                                    <i class="bi bi-clock label-icon"></i>
                                    ƒ∞lk ƒ∞√ßkiden Bu Yana Ge√ßen S√ºre
                                </label>
                                <div class="stepper-control">
                                    <button type="button" class="stepper-btn" onclick="changeHours(-0.5)">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <div class="stepper-value">
                                        <input type="number" class="modern-input text-center" id="hours" min="0"
                                            max="24" step="0.5" value="1" required>
                                        <span class="stepper-unit">saat</span>
                                    </div>
                                    <button type="button" class="stepper-btn" onclick="changeHours(0.5)">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block text-center">ƒ∞lk i√ßkinizi i√ßtiƒüinizden bu yana ka√ß
                                    saat ge√ßti?</small>
                            </div>
                        </div>

                        <!-- Step 2: ƒ∞√ßkiler -->

                        <!-- Step 2: ƒ∞√ßkiler -->
                        <div class="wizard-step" data-step="2">
                            <h3 class="step-title">ƒ∞√ßtikleriniz</h3>
                            <p class="step-description">Ne i√ßtiniz? Listeye ekleyin</p>

                            <!-- Quick Select Chips -->
                            <div class="form-group-modern">
                                <label class="modern-label">Hƒ±zlƒ± Se√ßim</label>
                                <div class="chip-container">
                                    <button type="button" class="drink-chip" onclick="addQuickDrink('Bira', 500, 5)">
                                        <span class="chip-icon">üç∫</span>
                                        Bira
                                    </button>
                                    <button type="button" class="drink-chip" onclick="addQuickDrink('≈ûarap', 150, 12)">
                                        <span class="chip-icon">üç∑</span>
                                        ≈ûarap
                                    </button>
                                    <button type="button" class="drink-chip" onclick="addQuickDrink('Rakƒ±', 50, 45)">
                                        <span class="chip-icon">ü•É</span>
                                        Rakƒ±
                                    </button>
                                    <button type="button" class="drink-chip" onclick="addQuickDrink('Viski', 40, 40)">
                                        <span class="chip-icon">ü•É</span>
                                        Viski
                                    </button>
                                    <button type="button" class="drink-chip" onclick="addQuickDrink('Vodka', 40, 40)">
                                        <span class="chip-icon">üç∏</span>
                                        Vodka
                                    </button>
                                    <button type="button" class="drink-chip"
                                        onclick="addQuickDrink('Kokteyl', 200, 15)">
                                        <span class="chip-icon">üçπ</span>
                                        Kokteyl
                                    </button>
                                </div>
                            </div>

                            <!-- Drinks List -->
                            <div id="drinksList" class="drinks-list"></div>

                            <!-- Live Stats -->
                            <div class="stat-chips-container mt-4">
                                <div class="stat-chip">
                                    <div class="stat-label">Toplam Hacim</div>
                                    <div class="stat-value"><span id="totalVolume">0</span> ml</div>
                                </div>
                                <div class="stat-chip">
                                    <div class="stat-label">Saf Alkol</div>
                                    <div class="stat-value"><span id="totalAlcoholLive">0</span> g</div>
                                </div>
                                <div class="stat-chip">
                                    <div class="stat-label">Tahmini BAC</div>
                                    <div class="stat-value"><span id="estimatedBAC">‚Äî</span></div>
                                </div>
                            </div>
                        </div>

                </div>

                <!-- Step 3: Sonu√ß -->
                <div class="wizard-step" data-step="3">
                    <div class="result-hero text-center">
                        <div class="hero-metric">
                            <div class="metric-value" id="bacValue">0.00‚Ä∞</div>
                            <div class="metric-label">Kan Alkol Seviyesi</div>
                        </div>
                        <div class="status-badge" id="bacStatus">
                            <span class="status-dot"></span>
                            <span class="status-text">Ayƒ±k</span>
                        </div>
                    </div>

                    <!-- Gauge / Progress Indicator -->
                    <div class="bac-gauge">
                        <div class="gauge-bar">
                            <div class="gauge-fill" id="gaugeFill"></div>
                            <div class="gauge-marker" style="left: 50%"></div>
                        </div>
                        <div class="gauge-labels">
                            <span>0‚Ä∞</span>
                            <span class="text-warning">0.5‚Ä∞</span>
                            <span class="text-danger">1.5‚Ä∞</span>
                        </div>
                    </div>

                    <!-- Recommendation Cards -->
                    <div class="recommendation-cards">
                        <div class="recommendation-card danger" id="drivingCard">
                            <div class="card-icon"><i class="bi bi-car-front-fill"></i></div>
                            <div class="card-content">
                                <div class="card-title">Ara√ß Kullanma</div>
                                <div class="card-desc" id="drivingStatus">G√ºvenli</div>
                            </div>
                        </div>
                        <div class="recommendation-card info" id="hydrationCard">
                            <div class="card-icon"><i class="bi bi-droplet-fill"></i></div>
                            <div class="card-content">
                                <div class="card-title">Su & Yemek</div>
                                <div class="card-desc">Hidrate kal</div>
                            </div>
                        </div>
                        <div class="recommendation-card success" id="soberCard">
                            <div class="card-icon"><i class="bi bi-clock-fill"></i></div>
                            <div class="card-content">
                                <div class="card-title">Sƒ±fƒ±rlanma</div>
                                <div class="card-desc" id="hoursToSober">0 saat</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="detailed-stats mt-4">
                        <div class="stat-row">
                            <span class="stat-label">Toplam Alkol</span>
                            <span class="stat-value" id="totalAlcohol">0 g</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">BAC Y√ºzdesi</span>
                            <span class="stat-value" id="bacPercentage">0.00%</span>
                        </div>
                    </div>

                    <!-- BAC Scale Reference (Collapsible) -->
                    <div class="accordion mt-4" id="bacScaleAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#bacScaleCollapse">
                                    <i class="bi bi-table me-2"></i>
                                    Promil Seviye Tablosu
                                </button>
                            </h2>
                            <div id="bacScaleCollapse" class="accordion-collapse collapse"
                                data-bs-parent="#bacScaleAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Promil</th>
                                                    <th>Durum</th>
                                                    <th>Etkiler</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="table-success">
                                                    <td>0.00 - 0.02‚Ä∞</td>
                                                    <td>Ayƒ±k</td>
                                                    <td>Herhangi bir etki yok</td>
                                                </tr>
                                                <tr class="table-info">
                                                    <td>0.02 - 0.05‚Ä∞</td>
                                                    <td>Minimal Etki</td>
                                                    <td>Hafif rahatlama</td>
                                                </tr>
                                                <tr class="table-warning">
                                                    <td>0.05 - 0.08‚Ä∞</td>
                                                    <td>Hafif Sarho≈üluk</td>
                                                    <td>Koordinasyon kaybƒ±</td>
                                                </tr>
                                                <tr class="table-warning">
                                                    <td>0.08 - 0.15‚Ä∞</td>
                                                    <td>Orta Sarho≈üluk</td>
                                                    <td>Motor kontrol kaybƒ±</td>
                                                </tr>
                                                <tr class="table-danger">
                                                    <td>0.15+‚Ä∞</td>
                                                    <td>Y√ºksek Sarho≈üluk</td>
                                                    <td>Ciddi risk</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </form>
            </div>

            <!-- Action Buttons -->
            <div class="wizard-footer d-flex justify-content-between gap-2">
                <button type="button" class="btn-wizard btn-secondary" id="bacPrevBtn" style="display: none;">
                    <i class="bi bi-arrow-left"></i>
                    Geri
                </button>
                <button type="button" class="btn-wizard btn-add" id="addDrinkBtn" style="display: none;"
                    onclick="addDrink()">
                    <i class="bi bi-plus-circle"></i>
                    ƒ∞√ßki Ekle
                </button>
                <button type="button" class="btn-wizard btn-primary" id="bacNextBtn">
                    Devam Et
                    <i class="bi bi-arrow-right"></i>
                </button>
                <button type="submit" class="btn-wizard btn-success" id="calculateBtn" style="display: none;"
                    form="bacForm">
                    <i class="bi bi-calculator"></i>
                    Hesapla
                </button>
                <button type="button" class="btn-wizard btn-primary" id="resetBtn" style="display: none;"
                    onclick="resetCalculator()">
                    <i class="bi bi-arrow-counterclockwise"></i>
                    Yeni Hesaplama
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // BAC Calculator - Modern Wizard System
    // ============================================

    let currentBacStep = 1;
    const totalBacSteps = 3;
    let drinkCounter = 0;
    let drinks = [];

    // Quick select drinks
    const quickDrinks = {
        'Bira': { icon: 'üç∫', volume: 500, alcohol: 5 },
        '≈ûarap': { icon: 'üç∑', volume: 150, alcohol: 12 },
        'Rakƒ±': { icon: 'ü•É', volume: 50, alcohol: 45 },
        'Viski': { icon: 'ü•É', volume: 40, alcohol: 40 },
        'Vodka': { icon: 'üç∏', volume: 40, alcohol: 40 },
        'Kokteyl': { icon: 'üçπ', volume: 200, alcohol: 15 }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        updateBacProgress();
        showBacStep(1);
        updateLiveSummary();
    });

    // ============================================
    // Step Navigation
    // ============================================

    function updateBacProgress() {
        const percentage = ((currentBacStep - 1) / (totalBacSteps - 1)) * 100;
        document.getElementById('bacProgressBar').style.width = percentage + '%';

        document.querySelectorAll('.wizard-progress .progress-step').forEach((step, index) => {
            const stepNum = index + 1;
            if (stepNum < currentBacStep) {
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (stepNum === currentBacStep) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active', 'completed');
            }
        });
    }

    function showBacStep(step) {
        currentBacStep = step;

        // Hide all steps
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));

        // Show current step
        document.querySelector('.wizard-step[data-step="' + step + '"]').classList.add('active');

        // Update footer buttons
        const prevBtn = document.getElementById('bacPrevBtn');
        const nextBtn = document.getElementById('bacNextBtn');
        const addBtn = document.getElementById('addDrinkBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');

        prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';
        nextBtn.style.display = step < 3 && step !== 2 ? 'inline-flex' : 'none';
        addBtn.style.display = step === 2 ? 'inline-flex' : 'none';
        calculateBtn.style.display = step === 2 ? 'inline-flex' : 'none';
        resetBtn.style.display = step === 3 ? 'inline-flex' : 'none';

        updateBacProgress();
    }

    function nextBacStep() {
        if (currentBacStep < totalBacSteps) {
            if (validateCurrentStep()) {
                showBacStep(currentBacStep + 1);
            }
        }
    }

    function prevBacStep() {
        if (currentBacStep > 1) {
            showBacStep(currentBacStep - 1);
        }
    }

    function validateCurrentStep() {
        if (currentBacStep === 1) {
            const weight = parseFloat(document.getElementById('weight').value);
            if (!weight || weight < 30 || weight > 300) {
                alert('L√ºtfen ge√ßerli bir kilo girin (30-300 kg)');
                return false;
            }
        }

        if (currentBacStep === 2) {
            if (drinks.length === 0) {
                alert('L√ºtfen en az bir i√ßki ekleyin!');
                return false;
            }
        }

        return true;
    }

    // ============================================
    // Weight Control
    // ============================================

    function updateWeight(value) {
        document.getElementById('weight').value = value;
        document.getElementById('weightSlider').value = value;
        updateLiveSummary();
    }

    function updateWeightSlider(value) {
        document.getElementById('weightSlider').value = value;
        updateLiveSummary();
    }

    // ============================================
    // Hours Stepper
    // ============================================

    function changeHours(delta) {
        const input = document.getElementById('hours');
        let value = parseFloat(input.value) || 0;
        value = Math.max(0, Math.min(48, value + delta));
        input.value = value.toFixed(1);
        updateLiveSummary();
    }

    // ============================================
    // Gender Selection
    // ============================================

    function selectGender(gender) {
        document.querySelectorAll('.segmented-option').forEach(opt => {
            opt.classList.remove('active');
        });
        event.target.closest('.segmented-option').classList.add('active');
        document.getElementById('gender').value = gender;
    }

    // ============================================
    // Drink Management
    // ============================================

    function addQuickDrink(name) {
        const drink = quickDrinks[name];
        if (drink) {
            addDrink(name, drink.volume, drink.alcohol, drink.icon);
        }
    }

    function addDrink(name = '', volume = '', alcohol = '', icon = 'ü•É') {
        const drinkId = drinkCounter++;
        const drinkCard = document.createElement('div');
        drinkCard.className = 'drink-card';
        drinkCard.dataset.id = drinkId;

        drinkCard.innerHTML = `
            <div class="drink-card-header">
                <div class="drink-card-title">
                    <span>${icon}</span>
                    <input type="text" class="form-control form-control-sm" 
                           style="max-width: 200px; border: none; font-weight: 700;" 
                           value="${name || 'ƒ∞√ßki ' + (drinkId + 1)}" 
                           placeholder="ƒ∞√ßki adƒ±">
                </div>
                <button type="button" class="btn-remove-drink" onclick="removeDrink(${drinkId})">
                    <i class="bi bi-trash"></i> Sil
                </button>
            </div>
            <div class="drink-card-inputs">
                <div class="form-group">
                    <label class="form-label">Hacim (ml)</label>
                    <input type="number" class="form-control drink-volume" 
                           value="${volume}" min="1" max="2000" 
                           onchange="updateLiveStats()" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Alkol %</label>
                    <input type="number" class="form-control drink-alcohol" 
                           value="${alcohol}" min="0" max="100" step="0.1"
                           onchange="updateLiveStats()" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Adet</label>
                    <input type="number" class="form-control drink-quantity" 
                           value="1" min="1" max="50"
                           onchange="updateLiveStats()" required>
                </div>
            </div>
        `;

        document.getElementById('drinksList').appendChild(drinkCard);
        updateLiveStats();
    }

    function removeDrink(drinkId) {
        const card = document.querySelector(`.drink-card[data-id="${drinkId}"]`);
        if (card) {
            card.remove();
            updateLiveStats();
        }
    }

    // ============================================
    // Live Statistics
    // ============================================

    function updateLiveSummary() {
        const hours = parseFloat(document.getElementById('hours').value) || 0;
        const drinkCount = document.querySelectorAll('.drink-card').length;

        document.getElementById('summaryHours').textContent = hours.toFixed(1);
        document.getElementById('summaryDrinks').textContent = drinkCount;
    }

    function updateLiveStats() {
        updateLiveSummary();

        let totalVolume = 0;
        let totalAlcoholMl = 0;

        document.querySelectorAll('.drink-card').forEach(card => {
            const volume = parseFloat(card.querySelector('.drink-volume').value) || 0;
            const alcohol = parseFloat(card.querySelector('.drink-alcohol').value) || 0;
            const quantity = parseInt(card.querySelector('.drink-quantity').value) || 1;

            totalVolume += volume * quantity;
            totalAlcoholMl += (volume * alcohol / 100) * quantity;
        });

        const totalAlcoholGrams = totalAlcoholMl * 0.789; // Alcohol density

        // Estimate BAC
        const weight = parseFloat(document.getElementById('weight').value) || 70;
        const gender = document.getElementById('gender').value || 'male';
        const hours = parseFloat(document.getElementById('hours').value) || 0;
        const r = gender === 'female' ? 0.55 : (gender === 'male' ? 0.68 : 0.61);

        let estimatedBAC = (totalAlcoholGrams / (weight * r * 10)) - (0.015 * hours);
        estimatedBAC = Math.max(0, estimatedBAC);

        document.getElementById('totalVolume').textContent = totalVolume.toFixed(0);
        document.getElementById('totalAlcoholLive').textContent = totalAlcoholGrams.toFixed(1);
        document.getElementById('estimatedBAC').textContent = estimatedBAC.toFixed(2);
        document.getElementById('summaryAlcohol').textContent = totalAlcoholGrams.toFixed(1);
    }

    // ============================================
    // Calculate & Display Results
    // ============================================

    async function calculateBAC() {
        if (!validateCurrentStep()) return;

        const drinksList = [];
        document.querySelectorAll('.drink-card').forEach(card => {
            const name = card.querySelector('input[type="text"]').value;
            const volume = parseFloat(card.querySelector('.drink-volume').value);
            const alcohol = parseFloat(card.querySelector('.drink-alcohol').value);
            const quantity = parseInt(card.querySelector('.drink-quantity').value);

            if (volume && alcohol) {
                drinksList.push({
                    name: `${name} (x${quantity})`,
                    volume: volume * quantity,
                    alcohol_percent: alcohol
                });
            }
        });

        const data = {
            weight: parseFloat(document.getElementById('weight').value),
            gender: document.getElementById('gender').value,
            hours: parseFloat(document.getElementById('hours').value),
            drinks: drinksList
        };

        try {
            const response = await fetch('/api/calculate_bac', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            displayResults(result);
            showBacStep(3);
        } catch (error) {
            console.error('Error:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        }
    }

    function displayResults(result) {
        // Update hero metric
        const promilValue = result.bac_promil || (result.bac * 10);
        document.getElementById('resultBacValue').textContent = promilValue.toFixed(2);

        // Update status badge
        const statusBadge = document.getElementById('resultStatus');
        const statusText = result.status;
        const statusColor = result.status_color;

        let badgeClass = 'sober';
        if (statusColor === 'danger') badgeClass = promilValue > 2 ? 'high' : 'moderate';
        else if (statusColor === 'warning') badgeClass = 'light';
        else if (statusColor === 'info') badgeClass = 'minimal';

        statusBadge.className = `status-badge ${badgeClass}`;
        statusBadge.innerHTML = `<span class="status-dot"></span>${statusText}`;

        // Animate gauge
        const gaugePercentage = Math.min(100, (promilValue / 4) * 100);
        setTimeout(() => {
            document.querySelector('.gauge-marker').style.left = gaugePercentage + '%';
        }, 100);

        // Update recommendation cards
        const canDrive = promilValue < 0.5;
        document.getElementById('drivingStatus').innerHTML = canDrive
            ? '<i class="bi bi-check-circle"></i>'
            : '<i class="bi bi-x-circle"></i>';
        document.getElementById('drivingText').textContent = canDrive
            ? 'Ara√ß kullanabilirsiniz'
            : 'Ara√ß kullanmayƒ±n!';
        document.querySelector('.recommendation-card.danger .card-desc').textContent = canDrive
            ? 'Kan alkol seviyeniz yasal sƒ±nƒ±rƒ±n altƒ±nda'
            : `Yasal sƒ±nƒ±rƒ±n ${((promilValue / 0.5) * 100 - 100).toFixed(0)}% √ºzerinde`;

        const waterLiters = Math.max(1, Math.ceil(promilValue * 2));
        document.getElementById('hydrationAmount').textContent = waterLiters;

        document.getElementById('soberTime').textContent = result.hours_to_sober;

        // Update detailed stats table
        const tableRows = [
            { label: 'Toplam Alkol', value: `${result.total_alcohol_grams} g` },
            { label: 'BAC Y√ºzdesi', value: `${result.bac_percentage}%` },
            { label: 'Ayƒ±lma S√ºresi', value: `${result.hours_to_sober} saat` },
            { label: 'T√ºketilen ƒ∞√ßki', value: `${result.drink_details.length} adet` }
        ];

        const tbody = document.querySelector('#detailedStatsTable tbody');
        tbody.innerHTML = '';
        tableRows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="stat-label">${row.label}</td>
                <td class="stat-value">${row.value}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function resetCalculator() {
        currentBacStep = 1;
        document.getElementById('weight').value = 70;
        document.getElementById('weightSlider').value = 70;
        document.getElementById('hours').value = 0;
        document.getElementById('gender').value = 'male';

        document.querySelectorAll('.segmented-option').forEach((opt, i) => {
            opt.classList.toggle('active', i === 0);
        });

        document.getElementById('drinksList').innerHTML = '';
        drinkCounter = 0;

        updateLiveSummary();
        updateLiveStats();
        showBacStep(1);
    }

    // Event listeners
    document.getElementById('bacPrevBtn').addEventListener('click', prevBacStep);
    document.getElementById('bacNextBtn').addEventListener('click', nextBacStep);
    document.getElementById('addDrinkBtn').addEventListener('click', () => addDrink());
    document.getElementById('calculateBtn').addEventListener('click', calculateBAC);
    document.getElementById('resetBtn').addEventListener('click', resetCalculator);
</script>
{% endblock %}