{% extends "base.html" %}

{% block title %}Profil OluÅŸtur - Ne Yenir?{% endblock %}

{% block content %}
<div class="profile-wizard-container">
    <div class="container" style="padding-top: 100px; padding-bottom: 60px;">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Header -->
                <div class="wizard-header text-center mb-4">
                    <div class="wizard-icon mb-3">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <h1 class="wizard-title">Profilini OluÅŸtur</h1>
                    <p class="wizard-subtitle">Ä°Ã§ecek Ã¶nerilerini kiÅŸiselleÅŸtir</p>
                </div>

                <!-- Progress Bar -->
                <div class="wizard-progress mb-5">
                    <div class="progress-container">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="progress-step active" data-step="1">
                            <div class="step-circle">1</div>
                            <div class="step-label">KiÅŸisel</div>
                        </div>
                        <div class="progress-step" data-step="2">
                            <div class="step-circle">2</div>
                            <div class="step-label">Zevkler</div>
                        </div>
                        <div class="progress-step" data-step="3">
                            <div class="step-circle">3</div>
                            <div class="step-label">Alkol & BÃ¼tÃ§e</div>
                        </div>
                        <div class="progress-step" data-step="4">
                            <div class="step-circle">4</div>
                            <div class="step-label">KÄ±sÄ±tlar</div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Card -->
                <div class="wizard-card">
                    <form id="profileWizardForm">
                        <!-- Step 1: KiÅŸisel Bilgiler -->
                        <div class="wizard-step active" data-step="1">
                            <h3 class="step-title">KiÅŸisel Bilgiler</h3>
                            <p class="step-description">BaÅŸlamak iÃ§in birkaÃ§ bilgiye ihtiyacÄ±mÄ±z var</p>

                            <div class="form-group-modern">
                                <label class="modern-label">
                                    <i class="bi bi-person-fill label-icon"></i>
                                    Ä°sim
                                </label>
                                <input type="text" class="modern-input" id="name" placeholder="AdÄ±nÄ±zÄ± girin" required>
                            </div>

                            <div class="form-group-modern">
                                <label class="modern-label">
                                    <i class="bi bi-calendar-event label-icon"></i>
                                    YaÅŸ
                                    <span class="helper-text">18 yaÅŸ ve Ã¼zeri</span>
                                </label>
                                <input type="number" class="modern-input" id="age" min="18" max="120"
                                    placeholder="YaÅŸÄ±nÄ±z" required>
                            </div>
                        </div>

                        <!-- Step 2: Zevkler -->
                        <div class="wizard-step" data-step="2">
                            <h3 class="step-title">Lezzet Profili</h3>
                            <p class="step-description">Hangi tatlarÄ± seviyorsun?</p>

                            <div class="form-group-modern">
                                <label class="modern-label">Tercih Edilen Lezzetler</label>
                                <div class="chip-container">
                                    <input type="checkbox" id="sweet" value="sweet" class="chip-input">
                                    <label for="sweet" class="chip-label">
                                        <span class="chip-icon">ğŸ¯</span>
                                        TatlÄ±
                                    </label>

                                    <input type="checkbox" id="salty" value="salty" class="chip-input">
                                    <label for="salty" class="chip-label">
                                        <span class="chip-icon">ğŸ§‚</span>
                                        Tuzlu
                                    </label>

                                    <input type="checkbox" id="sour" value="sour" class="chip-input">
                                    <label for="sour" class="chip-label">
                                        <span class="chip-icon">ğŸ‹</span>
                                        EkÅŸi
                                    </label>

                                    <input type="checkbox" id="bitter" value="bitter" class="chip-input">
                                    <label for="bitter" class="chip-label">
                                        <span class="chip-icon">â˜•</span>
                                        AcÄ±
                                    </label>

                                    <input type="checkbox" id="umami" value="umami" class="chip-input">
                                    <label for="umami" class="chip-label">
                                        <span class="chip-icon">ğŸ„</span>
                                        Umami
                                    </label>

                                    <input type="checkbox" id="spicy" value="spicy" class="chip-input">
                                    <label for="spicy" class="chip-label">
                                        <span class="chip-icon">ğŸŒ¶ï¸</span>
                                        BaharatlÄ±
                                    </label>

                                    <input type="checkbox" id="smoky" value="smoky" class="chip-input">
                                    <label for="smoky" class="chip-label">
                                        <span class="chip-icon">ğŸ”¥</span>
                                        DumanlÄ±
                                    </label>

                                    <input type="checkbox" id="fruity" value="fruity" class="chip-input">
                                    <label for="fruity" class="chip-label">
                                        <span class="chip-icon">ğŸ‡</span>
                                        Meyveli
                                    </label>
                                </div>
                            </div>

                            <div class="form-group-modern mt-4">
                                <label class="modern-label">Favori Mutfaklar</label>
                                <div class="chip-container">
                                    <input type="checkbox" id="turkish" value="Turkish" class="chip-input">
                                    <label for="turkish" class="chip-label">
                                        <span class="chip-icon">ğŸ‡¹ğŸ‡·</span>
                                        TÃ¼rk
                                    </label>

                                    <input type="checkbox" id="italian" value="Italian" class="chip-input">
                                    <label for="italian" class="chip-label">
                                        <span class="chip-icon">ğŸ‡®ğŸ‡¹</span>
                                        Ä°talyan
                                    </label>

                                    <input type="checkbox" id="french" value="French" class="chip-input">
                                    <label for="french" class="chip-label">
                                        <span class="chip-icon">ğŸ‡«ğŸ‡·</span>
                                        FransÄ±z
                                    </label>

                                    <input type="checkbox" id="japanese" value="Japanese" class="chip-input">
                                    <label for="japanese" class="chip-label">
                                        <span class="chip-icon">ğŸ‡¯ğŸ‡µ</span>
                                        Japon
                                    </label>

                                    <input type="checkbox" id="american" value="American" class="chip-input">
                                    <label for="american" class="chip-label">
                                        <span class="chip-icon">ğŸ‡ºğŸ‡¸</span>
                                        Amerikan
                                    </label>

                                    <input type="checkbox" id="british" value="British" class="chip-input">
                                    <label for="british" class="chip-label">
                                        <span class="chip-icon">ğŸ‡¬ğŸ‡§</span>
                                        Ä°ngiliz
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Alkol & BÃ¼tÃ§e -->
                        <div class="wizard-step" data-step="3">
                            <h3 class="step-title">Alkol & BÃ¼tÃ§e</h3>
                            <p class="step-description">Tercihlerini belirle</p>

                            <div class="form-group-modern">
                                <label class="modern-label">Alkol ToleransÄ±</label>
                                <div class="segmented-control">
                                    <input type="radio" name="tolerance" id="low" value="low" class="segment-input">
                                    <label for="low" class="segment-label">
                                        <span class="segment-title">DÃ¼ÅŸÃ¼k</span>
                                        <span class="segment-desc">1â€“2 kadeh</span>
                                    </label>

                                    <input type="radio" name="tolerance" id="medium" value="medium"
                                        class="segment-input" checked>
                                    <label for="medium" class="segment-label">
                                        <span class="segment-title">Orta</span>
                                        <span class="segment-desc">3â€“4 kadeh</span>
                                    </label>

                                    <input type="radio" name="tolerance" id="high" value="high" class="segment-input">
                                    <label for="high" class="segment-label">
                                        <span class="segment-title">YÃ¼ksek</span>
                                        <span class="segment-desc">5+ kadeh</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group-modern mt-4">
                                <label class="modern-label">
                                    <i class="bi bi-wallet2 label-icon"></i>
                                    BÃ¼tÃ§e Tercihi
                                </label>
                                <div class="segmented-control">
                                    <input type="radio" name="budget" id="budget-low" value="budget"
                                        class="segment-input">
                                    <label for="budget-low" class="segment-label">
                                        <span class="segment-icon">ğŸ’°</span>
                                        <span class="segment-title">Ekonomik</span>
                                    </label>

                                    <input type="radio" name="budget" id="budget-mid" value="mid-range"
                                        class="segment-input" checked>
                                    <label for="budget-mid" class="segment-label">
                                        <span class="segment-icon">ğŸ’¸</span>
                                        <span class="segment-title">Orta</span>
                                    </label>

                                    <input type="radio" name="budget" id="budget-high" value="premium"
                                        class="segment-input">
                                    <label for="budget-high" class="segment-label">
                                        <span class="segment-icon">ğŸ’</span>
                                        <span class="segment-title">Premium</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: KÄ±sÄ±tlar -->
                        <div class="wizard-step" data-step="4">
                            <h3 class="step-title">Diyet KÄ±sÄ±tlamalarÄ±</h3>
                            <p class="step-description">Varsa Ã¶zel tercihlerini belirt</p>

                            <div class="form-group-modern">
                                <label class="modern-label">Diyet KÄ±sÄ±tlamalarÄ± (Ä°steÄŸe BaÄŸlÄ±)</label>
                                <div class="chip-container">
                                    <input type="checkbox" id="vegetarian" value="vegetarian" class="chip-input">
                                    <label for="vegetarian" class="chip-label">
                                        <span class="chip-icon">ğŸ¥¬</span>
                                        Vejetaryen
                                    </label>

                                    <input type="checkbox" id="vegan" value="vegan" class="chip-input">
                                    <label for="vegan" class="chip-label">
                                        <span class="chip-icon">ğŸŒ±</span>
                                        Vegan
                                    </label>

                                    <input type="checkbox" id="glutenfree" value="gluten-free" class="chip-input">
                                    <label for="glutenfree" class="chip-label">
                                        <span class="chip-icon">ğŸŒ¾</span>
                                        Glutensiz
                                    </label>
                                </div>
                            </div>

                            <div class="summary-box mt-4">
                                <h5 class="summary-title">
                                    <i class="bi bi-check-circle-fill"></i>
                                    Profil Ã–zeti
                                </h5>
                                <div class="summary-content" id="profileSummary"></div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Navigation Footer -->
                <div class="wizard-footer">
                    <button type="button" class="btn-wizard btn-secondary" id="prevBtn" style="display: none;">
                        <i class="bi bi-arrow-left"></i>
                        Geri
                    </button>
                    <button type="button" class="btn-wizard btn-primary" id="nextBtn">
                        Devam Et
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button type="submit" class="btn-wizard btn-success" id="submitBtn" style="display: none;"
                        form="profileWizardForm">
                        <i class="bi bi-check-circle-fill"></i>
                        Profili OluÅŸtur
                    </button>
                </div>

                <div class="text-center mt-4">
                    <p class="privacy-note">
                        <i class="bi bi-shield-check"></i>
                        Verileriniz gÃ¼venle saklanÄ±r
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-body text-center p-5">
                <div class="success-icon mb-4">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h3 class="mb-3">Profil OluÅŸturuldu!</h3>
                <p class="text-muted mb-4">
                    KiÅŸiselleÅŸtirilmiÅŸ profilin baÅŸarÄ±yla oluÅŸturuldu.
                    ArtÄ±k sana Ã¶zel Ã¶neriler alabilirsin.
                </p>
                <a href="{{ url_for('main.recommend') }}" class="btn-wizard btn-primary">
                    Ä°lk Ã–nerilerimi Al
                    <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 1;
    const totalSteps = 4;

    function updateProgress() {
        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progressBar').style.width = progress + '%';

        // Update step indicators
        document.querySelectorAll('.progress-step').forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            if (stepNum <= currentStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
    }

    function showStep(step) {
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
        document.querySelector(`.wizard-step[data-step="${step}"]`).classList.add('active');

        // Update buttons
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';

        if (step === totalSteps) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-flex';
            updateSummary();
        } else {
            nextBtn.style.display = 'inline-flex';
            submitBtn.style.display = 'none';
        }

        updateProgress();
    }

    function updateSummary() {
        const name = document.getElementById('name').value;
        const age = document.getElementById('age').value;
        const tolerance = document.querySelector('input[name="tolerance"]:checked')?.value || 'SeÃ§ilmedi';
        const budget = document.querySelector('input[name="budget"]:checked')?.value || 'SeÃ§ilmedi';

        const flavors = Array.from(document.querySelectorAll('.chip-input[type="checkbox"]:checked'))
            .filter(cb => ['sweet', 'salty', 'sour', 'bitter', 'umami', 'spicy', 'smoky', 'fruity'].includes(cb.value))
            .map(cb => cb.nextElementSibling.textContent.trim());

        const summary = `
            <div class="summary-item">
                <strong>Ä°sim:</strong> ${name || '-'}
            </div>
            <div class="summary-item">
                <strong>YaÅŸ:</strong> ${age || '-'}
            </div>
            <div class="summary-item">
                <strong>Alkol ToleransÄ±:</strong> ${tolerance}
            </div>
            <div class="summary-item">
                <strong>BÃ¼tÃ§e:</strong> ${budget}
            </div>
            <div class="summary-item">
                <strong>Lezzetler:</strong> ${flavors.length > 0 ? flavors.join(', ') : 'SeÃ§ilmedi'}
            </div>
        `;

        document.getElementById('profileSummary').innerHTML = summary;
    }

    // Navigation
    document.getElementById('nextBtn').addEventListener('click', () => {
        if (validateStep(currentStep)) {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    function validateStep(step) {
        if (step === 1) {
            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;

            if (!name || name.length < 2) {
                alert('LÃ¼tfen geÃ§erli bir isim girin');
                return false;
            }
            if (!age || age < 18 || age > 120) {
                alert('LÃ¼tfen geÃ§erli bir yaÅŸ girin (18-120)');
                return false;
            }
        }
        return true;
    }

    // Form submission
    document.getElementById('profileWizardForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const name = document.getElementById('name').value;
        const age = document.getElementById('age').value;
        const tolerance = document.querySelector('input[name="tolerance"]:checked').value;
        const budget = document.querySelector('input[name="budget"]:checked').value;

        const flavorCheckboxes = document.querySelectorAll('.chip-input[type="checkbox"]:checked');
        const preferredFlavors = Array.from(flavorCheckboxes)
            .filter(cb => ['sweet', 'salty', 'sour', 'bitter', 'umami', 'spicy', 'smoky', 'fruity'].includes(cb.value))
            .map(cb => cb.value);

        const cuisineCheckboxes = document.querySelectorAll('.chip-input[type="checkbox"]:checked');
        const favoriteCuisines = Array.from(cuisineCheckboxes)
            .filter(cb => ['Turkish', 'Italian', 'French', 'Japanese', 'American', 'British'].includes(cb.value))
            .map(cb => cb.value);

        const dietaryCheckboxes = document.querySelectorAll('.chip-input[type="checkbox"]:checked');
        const dietaryRestrictions = Array.from(dietaryCheckboxes)
            .filter(cb => ['vegetarian', 'vegan', 'gluten-free'].includes(cb.value))
            .map(cb => cb.value);

        const profileData = {
            name: name,
            age: parseInt(age),
            alcohol_tolerance: tolerance,
            preferred_flavors: preferredFlavors,
            budget_preference: budget,
            favorite_cuisines: favoriteCuisines,
            dietary_restrictions: dietaryRestrictions,
            disliked_alcohols: []
        };

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> OluÅŸturuluyor...';

        fetch('/create_profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profileData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();
                } else {
                    alert('Profil oluÅŸturulurken hata oluÅŸtu');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Profil oluÅŸturulurken hata oluÅŸtu');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
    });

    // Initialize
    showStep(1);
</script>
{% endblock %}