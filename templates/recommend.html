{% extends "base.html" %}

{% block title %}√ñneriler Al - Ne Yenir?{% endblock %}

{% block content %}
<div class="container" style="padding-top: 100px;">
    <div class="row">
        <div class="col-lg-12 mx-auto">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-white mb-3">
                    Yemeƒüinizi Se√ßin
                </h1>
                <p class="lead text-white-50">
                    Bir yemek se√ßin ve AI ile gurme uzmanlarƒ±ndan i√ßecek √∂nerileri alƒ±n
                </p>
            </div>

            <!-- Food Selection -->
            <div class="card modern-selection-container">
                <div class="card-header modern-selection-header">
                    <div class="d-flex align-items-center gap-3">
                        <div class="selection-icon-badge">
                            <i class="bi bi-search"></i>
                        </div>
                        <div>
                            <h4 class="mb-0 text-white fw-bold">Yemek Se√ßimi</h4>
                            <small class="text-white-50">{{ foods|length }} lezzetli se√ßenek</small>
                        </div>
                    </div>
                </div>
                <div class="card-body modern-selection-body">
                    <div class="row g-4" id="foodGrid">
                        {% for food in foods %}
                        <div class="col-lg-4 col-md-6 selection-item" style="animation-delay: {{ (loop.index - 1) * 0.05 }}s;">
                            <div class="modern-food-selection-card"
                                data-food-name="{{ food.name }}"
                                onclick="selectFood('{{ food.name }}', '{{ food.cuisine_type }}', '{{ food.intensity }}')">
                                <div class="selection-card-glow"></div>
                                
                                <div class="card-body">
                                    <!-- Header with Flag & Badge -->
                                    <div class="selection-header mb-3">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span class="food-flag-icon">
                                                {% if food.cuisine_type == 'Turkish' %}üáπüá∑
                                                {% elif food.cuisine_type == 'French' %}üá´üá∑
                                                {% elif food.cuisine_type == 'Italian' %}üáÆüáπ
                                                {% elif food.cuisine_type == 'Japanese' %}üáØüáµ
                                                {% elif food.cuisine_type == 'British' %}üá¨üáß
                                                {% elif food.cuisine_type == 'American' %}üá∫üá∏
                                                {% elif food.cuisine_type == 'Chinese' %}üá®üá≥
                                                {% elif food.cuisine_type == 'Indian' %}üáÆüá≥
                                                {% elif food.cuisine_type == 'Mexican' %}üá≤üáΩ
                                                {% elif food.cuisine_type == 'Spanish' %}üá™üá∏
                                                {% elif food.cuisine_type == 'Greek' %}üá¨üá∑
                                                {% else %}üåç
                                                {% endif %}
                                            </span>
                                            <h5 class="selection-title mb-0">{{ food.name }}</h5>
                                        </div>
                                        <span class="cuisine-badge-selection">{{ food.cuisine_type|translate_cuisine }}</span>
                                    </div>

                                    <!-- Flavor Tags -->
                                    <div class="selection-flavors mb-3">
                                        <div class="flavor-tags-row">
                                            {% for flavor in food.flavor_profile[:3] %}
                                            <span class="flavor-tag-selection">{{ flavor|translate_flavor }}</span>
                                            {% endfor %}
                                            {% if food.flavor_profile|length > 3 %}
                                            <span class="flavor-tag-more">+{{ food.flavor_profile|length - 3 }}</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Stats Row -->
                                    <div class="selection-stats">
                                        <div class="stat-item-selection">
                                            <i class="bi bi-fire text-danger"></i>
                                            <span class="stat-label-selection">Yoƒüunluk</span>
                                            <span class="stat-value-selection">{{ food.intensity }}/10</span>
                                        </div>
                                        <div class="stat-divider-selection"></div>
                                        <div class="stat-item-selection">
                                            <i class="bi bi-tag text-success"></i>
                                            <span class="stat-label-selection">{{ food.price_range|translate_price }}</span>
                                        </div>
                                    </div>

                                    <!-- Hover Action -->
                                    <div class="selection-action">
                                        <i class="bi bi-arrow-right-circle-fill"></i>
                                        <span>√ñneri Al</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- √ñneriler Modalƒ± -->
<div class="modal fade" id="recommendationsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content modern-modal">
            <div class="modal-header modern-modal-header">
                <div class="d-flex align-items-center gap-3">
                    <div class="modal-icon">
                        <i class="bi bi-lightbulb-fill"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0">
                            <span id="selectedFoodName"></span> i√ßin AI √ñnerileri
                        </h5>
                        <small class="text-white-50">Yapay zeka ve gurme uzmanlarƒ±ndan √∂neriler</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modern-modal-body">
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="loading-content">
                        <div class="spinner-modern">
                            <div class="spinner-ring"></div>
                            <div class="spinner-ring"></div>
                            <div class="spinner-ring"></div>
                            <i class="bi bi-robot spinner-icon"></i>
                        </div>
                        <h5 class="mt-4 mb-2">AI Analiz Yapƒ±yor</h5>
                        <p class="text-muted">M√ºkemmel e≈üle≈ütirmeler hazƒ±rlanƒ±yor...</p>
                    </div>
                </div>

                <div id="recommendationsContent" style="display: none;">
                    <!-- Recommendations will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Puanlama Modalƒ± -->
<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bu E≈üle≈ütirmeyi Oyla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h6 id="ratingPairText"></h6>
                <div class="rating-input my-4">
                    <i class="bi bi-star rating-star" data-rating="1"></i>
                    <i class="bi bi-star rating-star" data-rating="2"></i>
                    <i class="bi bi-star rating-star" data-rating="3"></i>
                    <i class="bi bi-star rating-star" data-rating="4"></i>
                    <i class="bi bi-star rating-star" data-rating="5"></i>
                </div>
                <p class="text-muted">Bu e≈üle≈ütirmeyi oylamak i√ßin yƒ±ldƒ±zlara tƒ±klayƒ±n</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" id="submitRating">Oyumu G√∂nder</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFood = '';
    let selectedAlcohol = '';
    let currentRating = 0;

    function selectFood(foodName, cuisine, intensity) {
        selectedFood = foodName;
        document.getElementById('selectedFoodName').textContent = foodName;

        // Show modal and loading spinner
        const modal = new bootstrap.Modal(document.getElementById('recommendationsModal'));
        modal.show();

        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('recommendationsContent').style.display = 'none';

        // Fetch recommendations
        fetch(`/api/recommendations/${foodName.replace(/ /g, '-')}`)
            .then(response => response.json())
            .then(data => {
                displayRecommendations(data);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('recommendationsContent').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').innerHTML = '<p class="text-danger">√ñneriler y√ºklenirken hata olu≈ütu</p>';
            });
    }

    function displayRecommendations(data) {
        const content = document.getElementById('recommendationsContent');
        let html = '';

        // AI Recommendations Section
        if (data.ai_recommendations && data.ai_recommendations.length > 0) {
            html += `
            <div class="mb-5">
                <div class="section-header mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="section-icon ai-icon">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div>
                            <h4 class="mb-0 fw-bold">AI √ñnerileri</h4>
                            <small class="text-muted">Yapay zeka destekli akƒ±llƒ± e≈üle≈ütirmeler</small>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
            `;

            data.ai_recommendations.forEach((rec, index) => {
                const alcoholIcon = getAlcoholIcon(rec.type);
                const scoreColor = getScoreColor(rec.score);
                const scoreGradient = getScoreGradient(rec.score);

                html += `
                <div class="col-lg-4 col-md-6 recommendation-item" style="animation-delay: ${index * 0.1}s">
                    <div class="modern-recommendation-card">
                        <div class="card-glow ${scoreColor}"></div>
                        
                        <div class="card-content">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="alcohol-icon-badge">${alcoholIcon}</span>
                                        <h5 class="card-title-modern mb-0">
                                            ${rec.name}
                                        </h5>
                                    </div>
                                    <div class="card-meta mb-2">
                                        <span class="meta-item">
                                            <i class="bi bi-cup"></i> ${rec.type.charAt(0).toUpperCase() + rec.type.slice(1)}
                                        </span>
                                        <span class="meta-divider">‚Ä¢</span>
                                        <span class="meta-item">
                                            <i class="bi bi-tag"></i> ${rec.subtype}
                                        </span>
                                        <span class="meta-divider">‚Ä¢</span>
                                        <span class="meta-item">
                                            <i class="bi bi-geo-alt"></i> ${rec.region}
                                        </span>
                                    </div>
                                    <div class="card-specs">
                                        <span class="spec-badge">
                                            <i class="bi bi-percent"></i> ${rec.alcohol_content}% Alkol
                                        </span>
                                        <span class="spec-badge">
                                            <i class="bi bi-cash"></i> ${rec.price_range}
                                        </span>
                                        <span class="spec-badge">
                                            <i class="bi bi-droplet"></i> ${rec.body} g√∂vde
                                        </span>
                                    </div>
                                </div>
                                <div class="score-section">
                                    <div class="modern-score-badge ${scoreColor}">
                                        <div class="score-number">${rec.score}</div>
                                        <div class="score-label">/ 100</div>
                                    </div>
                                    <div class="score-label-text">${getScoreLabel(rec.score)}</div>
                                </div>
                            </div>
                            
                            <div class="progress-modern mb-3">
                                <div class="progress-fill ${scoreColor}" style="width: 0%; animation: fillProgress 1s ease forwards ${index * 0.1 + 0.3}s; --target-width: ${rec.score}%">
                                    <span class="progress-shimmer"></span>
                                </div>
                            </div>
                            
                            <div class="explanation-box mb-3">
                                <i class="bi bi-lightbulb explanation-icon"></i>
                                <p class="explanation-text mb-0">
                                    ${rec.explanation}
                                </p>
                            </div>
                            
                            <div class="flavor-tags mb-3">
                                <div class="flavor-label">
                                    <i class="bi bi-palette"></i> Lezzet Profili:
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    ${rec.flavor_profile.map((flavor, idx) =>
                        `<span class="flavor-tag" style="animation-delay: ${idx * 0.05}s">${flavor}</span>`
                    ).join('')}
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn-modern btn-rate" onclick="showRatingModal('${rec.name}')">
                                    <i class="bi bi-star-fill"></i>
                                    <span>Oyla</span>
                                </button>
                                <button class="btn-modern btn-details" onclick="showDetails('${rec.name}')">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <span>Detaylar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div></div>';
        }

        // Expert Recommendations Section
        if (data.expert_recommendations && data.expert_recommendations.length > 0) {
            html += `
            <div class="mb-4">
                <div class="section-header mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="section-icon expert-icon">
                            <i class="bi bi-person-badge"></i>
                        </div>
                        <div>
                            <h4 class="mb-0 fw-bold">Gurme Uzmanƒ± √ñnerileri</h4>
                            <small class="text-muted">D√ºnya √ßapƒ±nda √ºnl√º ≈üeflerden √∂neriler</small>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
            `;

            data.expert_recommendations.forEach((rec, index) => {
                const expertInfo = rec.expert || {};
                const stars = expertInfo.michelin_stars > 0 ? '‚≠ê'.repeat(expertInfo.michelin_stars) : 'üèÜ';
                const scoreColor = getScoreColor(rec.score);

                html += `
                <div class="col-lg-4 col-md-6 recommendation-item" style="animation-delay: ${index * 0.1}s">
                    <div class="modern-recommendation-card expert-card">
                        <div class="card-glow expert-glow"></div>
                        
                        <div class="expert-badge">
                            <i class="bi bi-award-fill"></i>
                            <span>Gurme Uzmanƒ±</span>
                        </div>
                        
                        <div class="card-content">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="expert-header mb-3">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="expert-avatar">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <div>
                                                <h6 class="expert-name mb-1">
                                                    ${expertInfo.name || 'Uzman'} ${stars}
                                                </h6>
                                                <div class="expert-meta">
                                                    <span class="expert-country">
                                                        <i class="bi bi-geo-alt-fill"></i> ${expertInfo.country || ''}
                                                    </span>
                                                </div>
                                                ${expertInfo.bio ? `
                                                <p class="expert-bio">${expertInfo.bio}</p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="recommendation-title mb-2">
                                        <h5 class="card-title-modern mb-0">
                                            ${rec.name}
                                        </h5>
                                    </div>
                                </div>
                                <div class="score-section">
                                    <div class="modern-score-badge expert-score">
                                        <div class="score-number">${rec.score}</div>
                                        <div class="score-label">/ 100</div>
                                    </div>
                                    <div class="score-label-text">${getScoreLabel(rec.score)}</div>
                                </div>
                            </div>
                            
                            <div class="progress-modern mb-3">
                                <div class="progress-fill expert-progress" style="width: 0%; animation: fillProgress 1s ease forwards ${index * 0.1 + 0.3}s; --target-width: ${rec.score}%">
                                    <span class="progress-shimmer"></span>
                                </div>
                            </div>
                            
                            <div class="explanation-box expert-explanation mb-3">
                                <i class="bi bi-chat-quote explanation-icon"></i>
                                <p class="explanation-text mb-0">
                                    "${rec.explanation}"
                                </p>
                            </div>
                            
                            ${expertInfo.speciality ? `
                            <div class="expert-specialities mb-3">
                                <div class="flavor-label">
                                    <i class="bi bi-star-fill"></i> Uzmanlƒ±k Alanlarƒ±:
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    ${expertInfo.speciality.map((spec, idx) =>
                        `<span class="expert-tag" style="animation-delay: ${idx * 0.05}s">${spec}</span>`
                    ).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${expertInfo.famous_for ? `
                            <div class="famous-for-section">
                                <i class="bi bi-trophy-fill"></i>
                                <span class="famous-label">√únl√º olduƒüu alanlar:</span>
                                <span class="famous-text">${expertInfo.famous_for.join(', ')}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div></div>';
        }

        if (!data.ai_recommendations?.length && !data.expert_recommendations?.length) {
            html = '<div class="text-center text-black"><p>Bu yemek i√ßin hen√ºz √∂neri bulunmamaktadƒ±r.</p></div>';
        }

        content.innerHTML = html;
    }

    function getAlcoholIcon(type) {
        const icons = {
            'wine': 'üç∑',
            'beer': 'üç∫',
            'spirits': 'ü•É',
            'cocktail': 'üç∏',
            'sake': 'üç∂'
        };
        return icons[type] || 'ü•Ç';
    }

    function getScoreColor(score) {
        if (score >= 80) return 'success';
        if (score >= 70) return 'info';
        if (score >= 60) return 'warning';
        return 'secondary';
    }

    function getScoreGradient(score) {
        if (score >= 80) return 'linear-gradient(135deg, #10B981, #059669)';
        if (score >= 70) return 'linear-gradient(135deg, #06B6D4, #0891B2)';
        if (score >= 60) return 'linear-gradient(135deg, #F59E0B, #D97706)';
        return 'linear-gradient(135deg, #6B7280, #4B5563)';
    }

    function getScoreLabel(score) {
        if (score >= 90) return 'M√ºkemmel';
        if (score >= 80) return 'Harika';
        if (score >= 70) return 'ƒ∞yi';
        if (score >= 60) return 'Uygun';
        return 'Orta';
    }

    function showRatingModal(alcoholName) {
        rateThisPairing(alcoholName);
    }

    function showDetails(alcoholName) {
        alert('Detay sayfasƒ± yakƒ±nda eklenecek!');
    }

    function rateThisPairing(alcoholName) {
        selectedAlcohol = alcoholName;
        document.getElementById('ratingPairText').textContent = `${selectedFood} + ${alcoholName}`;

        // Reset rating
        currentRating = 0;
        document.querySelectorAll('.rating-star').forEach(star => {
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
        });

        const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
        ratingModal.show();
    }

    // Rating system
    document.addEventListener('DOMContentLoaded', function () {
        const ratingStars = document.querySelectorAll('.rating-star');

        ratingStars.forEach(star => {
            star.addEventListener('click', function () {
                currentRating = parseInt(this.dataset.rating);
                updateStars();
            });

            star.addEventListener('mouseover', function () {
                const hoverRating = parseInt(this.dataset.rating);
                updateStars(hoverRating);
            });
        });

        document.querySelector('.rating-input').addEventListener('mouseleave', function () {
            updateStars();
        });

        document.getElementById('submitRating').addEventListener('click', function () {
            if (currentRating > 0) {
                submitRating();
            } else {
                alert('L√ºtfen √∂nce bir puan verin!');
            }
        });
    });

    function updateStars(hoverRating = null) {
        const rating = hoverRating || currentRating;
        document.querySelectorAll('.rating-star').forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('bi-star');
                star.classList.add('bi-star-fill');
            } else {
                star.classList.remove('bi-star-fill');
                star.classList.add('bi-star');
            }
        });
    }

    function submitRating() {
        fetch('/api/rate_pairing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                food_name: selectedFood,
                alcohol_name: selectedAlcohol,
                rating: currentRating
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();
                    alert('Oyunuz i√ßin te≈üekk√ºrler! Geri bildiriminiz √∂nerilerimizi geli≈ütirmeye yardƒ±mcƒ± oluyor.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Oy g√∂nderilirken hata olu≈ütu. L√ºtfen tekrar deneyin.');
            });
    }

    // Yemek kartƒ± hover efektleri
    document.addEventListener('DOMContentLoaded', function () {
        const foodCards = document.querySelectorAll('.food-item-card');

        foodCards.forEach(card => {
            card.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
            });

            card.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 10px 40px rgba(0, 0, 0, 0.1)';
            });
        });
    });
</script>

{% endblock %}